<?xml version="1.0" encoding="utf-8"?>
<mx:TabNavigator xmlns:mx="http://www.adobe.com/2006/mxml" width="938" height="627"
		borderThickness="0" borderStyle="none" xmlns:comp="com.adobe.flex.extras.controls.*" creationComplete="init()" alpha="1.0" backgroundColor="#E3E6EB" borderColor="#CBCECE" backgroundAlpha="0.4">
	
	<mx:Script>
		<![CDATA[
			import bean.avaliacoes.Avaliacao;
			import bean.Utilitarios.Constantes;
			import bean.Utilitarios.Util;
			import com.flexspy.imp.Utils;
			import mx.binding.utils.BindingUtils;
			import bean.roteiros.Roteiro;
			import bean.roteiros.EquipeHasUsuarioHasRoteiro;
			import mx.effects.Rotate;
			import mx.controls.Image;
			import mx.controls.Alert;
			import flash.net.navigateToURL;
			import bean.Utilitarios.CastDeEntidades;
			import eventos.RespostaLoginEvent;
			import eventos.ObjetoEvent;
			import mx.collections.ArrayCollection;
			import bean.acesso.GrupoUsuario;
			import mx.rpc.events.ResultEvent;
			import eventos.FechaPopupEvent;
			import mx.rpc.events.FaultEvent;
			import Scripts.ControladorDeModulos;
			
			private var idUsuario:int;
			private var gU:Object = new Object();
			private var gruposUsuario:ArrayCollection = new ArrayCollection();
			private const FILE_UPLOAD_URL:String = Constantes.urlUploadDonwload;
			private var fileRef:FileReference = new FileReference();
			private var request:URLRequest = new URLRequest(ExternalInterface.call('downLoadRoteiro'));
			private var nomeArquivoInterface: String = "";
			private var nomeArquivoTestes: String = "";
			
			[Bindable]
			private var roteiro: Roteiro = new Roteiro();
			
			private function init():void {
				facade.channelSet = ControladorDeModulos.criaCanal("easyCorrection", ExternalInterface.call('getCanalSeguro'));
				ControladorDeModulos.getParam();
				this.systemManager.addEventListener(ObjetoEvent.ObjetoEventConst, temRoteiro);
				getGrupoUsuarioPorUsuario();
				buttonBaixarTestes.enabled = false;
				buttonBaixarInterface.enabled = false;
				buttonVisulizarCorrecao.enabled = false;
				getRoteirosLiberados();
			}
			
			private function getGrupoUsuarioPorUsuario():void{
				idUsuario = SharedObject.getLocal("sistema", "/").data.idUsuario;
			}
			
			private function temRoteiro(event: ObjetoEvent):void{
				getRoteirosLiberados();
			}
			
			private function falha(event:FaultEvent):void {
				var mensagem:String;
				try{
					if (event.fault.rootCause.message == null) {
						mensagem = event.fault.faultString;
					} else {
						mensagem = event.fault.rootCause.message;
					} 
				}
				catch(e:Error){
					mensagem = "Serviço indisponível, reinicie a operação.";
				}
				ControladorDeModulos.criaModulo("modulos/sistema/MensagemStatus.swf", this, new Array(true, mensagem));
			}
			
			private function getRoteirosLiberados():void{
				facade.getOperation("getRoteirosLiberados").send();
			}
			
			private function getRoteirosLiberados_result(event:ResultEvent):void{
				listaRoteiros.dataProvider = event.result as ArrayCollection;
				if ((listaRoteiros.dataProvider as ArrayCollection).length == 0){
					buttonBaixarTestes.enabled = false;
					buttonBaixarInterface.enabled = false;
					buttonVisualizarNotas.enabled = false;
					buttonVisulizarCorrecao.enabled = false;
				}
			}
			
			private function atualizaDadosRoteiro(): void{
				try{
					roteiro = CastDeEntidades.castRoteiro(listaRoteiros.selectedItem);
					inputTituloRoteiro.text = roteiro.nome;
					resumoText.text = roteiro.descricao;
					inputNumeroMaximoEnvios.text = String(roteiro.numeroMaximoEnvios);
					inputIntegrantesPorEquipe.text = String(roteiro.numeroMaximoParticipantes);
					inputPenalidades.text = String(roteiro.penalidadeDiasAtraso);
					inputDataFinal.text = Util.formataData(roteiro.dataFinalDiscussao);
					inputDataEntrega.text = Util.formataData(roteiro.dataFinalEntrega);
					inputDataLiberacao.text = Util.formataData(roteiro.dataLiberacao);
					inputHoraDiscussao.text = Util.organizaUnidadeTempo(String(roteiro.dataFinalDiscussao.hours)) + ":" + 
						Util.organizaUnidadeTempo(String(roteiro.dataFinalDiscussao.minutes));
					inputHoraEntrega.text = Util.organizaUnidadeTempo(String(roteiro.dataFinalEntrega.hours)) + ":" + 
						Util.organizaUnidadeTempo(String(roteiro.dataFinalEntrega.minutes));
					inputHoraLiberacao.text = Util.organizaUnidadeTempo(String(roteiro.dataLiberacao.hours)) + ":" + 
						Util.organizaUnidadeTempo(String(roteiro.dataLiberacao.minutes));
					
					// mostra os integrantes da equipe
					// integrantesEquipeRoteiro
					
					// habilita os botes
					//buttonVisualizarNotas.enabled = true;
					//buttonVisulizarCorrecao.enabled = true;
					carregaArquivos();
					facade.getOperation("getEquipeHasUsuarioHasRoteiroPorUsuarioERoteiro").send(idUsuario, roteiro.id);
				}
				catch(e: Error){}
			}
			
			private function getEquipeHasUsuarioHasRoteiroPorUsuarioERoteiro_result(event:ResultEvent):void{
				var eur: EquipeHasUsuarioHasRoteiro = new EquipeHasUsuarioHasRoteiro();
				eur = CastDeEntidades.castEquipeHasUsuarioHasRoteiro(event.result);
				if(eur != null){
					facade.getOperation("getEquipeHasUsuarioHasRoteiroPorEquipeERoteiro").send(eur.equipe.id, eur.roteiro.id);
				}
			}
			
			private function getEquipeHasUsuarioHasRoteiroPorEquipeERoteiro_result(event:ResultEvent):void{
				var listaEUR: ArrayCollection = event.result as ArrayCollection;
				integrantesEquipeRoteiro.dataProvider = new ArrayCollection();
				var idUsuario: int = SharedObject.getLocal("sistema", "/").data.idUsuario;
				if(listaEUR.length > 0){
					integrantesEquipeRoteiro.dataProvider = listaEUR;
				}
				for (var i: int = 0; i < listaEUR.length; i++){
					var eur: EquipeHasUsuarioHasRoteiro = CastDeEntidades.castEquipeHasUsuarioHasRoteiro(listaEUR.getItemAt(i));
					if (eur.usuario.idUsuario == idUsuario){
						facade.getOperation("getAvaliacoesPorEquipeERoteiro").send(eur.equipe.id, eur.roteiro.id);
						break;
					}
				}
			}
			
			private function getAvaliacoesPorEquipeERoteiro_result(event:ResultEvent):void{
				var listaAva: ArrayCollection = event.result as ArrayCollection;
				try{
					var avaliacao: Avaliacao = CastDeEntidades.castAvaliacao(listaAva.getItemAt(0));
					inputNotaAutomatica.text = Util.formataValor(String(avaliacao.notaAutomatica));
					inputNotaCorretor.text = Util.formataValor(String(avaliacao.notaCorrecao));
				} catch(e: Error){
					inputNotaAutomatica.text = "0,0";
					inputNotaCorretor.text = "0,0";
				}
			}
			
			private function carregaArquivos(): void{
				carregaInterface();
			}
			
			private function visualizarNotas(): void{
				ControladorDeModulos.criaModulo("modulos/Views/VisualizacaoDeNotas.swf", this, "");
			}
			
			private function visualizarCorrecao(): void{
				ControladorDeModulos.criaModulo("modulos/Views/ModuloCorrecao.swf", this, "");
			}
			
			private function carregaInterface(): void{
				try{
					facade.getOperation("getNomeArquivoInterface").send(roteiro);
				}
				catch(e: Error){
					var mensagem:String = "Selecione Um Roteiro.";
					ControladorDeModulos.criaModulo("modulos/sistema/MensagemStatus.swf", this, new Array(true, mensagem));
				}
			}
			
			private function labelIntegrantesEquipeRoteiro(item:*):String {
				return item.usuario.nome;
			}
			
			private function getNomeArquivoInterface_result(event:ResultEvent):void{
				nomeArquivoInterface = String(event.result);
				facade.getOperation("getNomeArquivoTestes").send(roteiro);
			}
			
			private function getNomeArquivoTestes_result(event:ResultEvent):void{
				nomeArquivoTestes = String(event.result);
				buttonBaixarTestes.enabled = true;
				buttonBaixarInterface.enabled = true;
			}
			
			private function baixarInterface(): void{
				try{
					var variables:URLVariables = new URLVariables();
					variables.nomeArquivo = roteiro.diretorioInterface + nomeArquivoInterface;
					request.data = variables;
					fileRef.download(request, nomeArquivoInterface);		
				}
				catch(e: Error){
					var mensagem:String = "Selecione Um Roteiro.";
					ControladorDeModulos.criaModulo("modulos/sistema/MensagemStatus.swf", this, new Array(true, mensagem));
				}
			}
			
			private function baixarTestes(): void{
				try{
					var variables:URLVariables = new URLVariables();
					variables.nomeArquivo = roteiro.diretorioTestes + nomeArquivoTestes;
					request.data = variables;
					fileRef.download(request, nomeArquivoTestes);
				}
				catch(e: Error){
					var mensagem:String = "Selecione Um Roteiro.";
					ControladorDeModulos.criaModulo("modulos/sistema/MensagemStatus.swf", this, new Array(true, mensagem));
				}
			}
		]]>
	</mx:Script>	
	
	<mx:RemoteObject id="facade" destination="easyCorrection" showBusyCursor="true">		
		<mx:method name="getRoteirosLiberados" result="getRoteirosLiberados_result(event)" fault="falha(event)"/>
		<mx:method name="getNomeArquivoInterface" result="getNomeArquivoInterface_result(event)" fault="falha(event)"/>
		<mx:method name="getNomeArquivoTestes" result="getNomeArquivoTestes_result(event)" fault="falha(event)"/>
		<mx:method name="getEquipeHasUsuarioHasRoteiroPorUsuarioERoteiro" result="getEquipeHasUsuarioHasRoteiroPorUsuarioERoteiro_result(event)" fault="falha(event)"/>
		<mx:method name="getEquipeHasUsuarioHasRoteiroPorEquipeERoteiro" result="getEquipeHasUsuarioHasRoteiroPorEquipeERoteiro_result(event)" fault="falha(event)"/>
		<mx:method name="getAvaliacoesPorEquipeERoteiro" result="getAvaliacoesPorEquipeERoteiro_result(event)" fault="falha(event)"/>
	</mx:RemoteObject>
		
	<mx:Canvas label="Roteiros" id="canvasRoteiros">
	
		<mx:Label x="331" y="12" text="Detalhes do Roteiro" fontWeight="bold" fontStyle="normal" fontSize="14"/>
		<mx:Label x="14" y="552" text="Total de Projetos Inscritos:" id="labelTotalProjetosInscritos" visible="false"/>
		<mx:Label x="198" y="552" width="85" id="totalProjetosInscritos" visible="false"/>
		<mx:Label x="10" y="461" text="Equipe:"/>
		<mx:LinkButton x="454.8" y="520" id="buttonBaixarInterface" icon="@Embed(source='../../image/entradaDeProduto.png')" label="   Baixar Interface" click="baixarInterface()"/>
		<mx:LinkButton x="636.8" y="520" id="buttonBaixarTestes" icon="@Embed(source='../../image/entradaDeProduto.png')" label="   Baixar Testes" click="baixarTestes()"/>
		<mx:LinkButton x="435.8" y="551" id="buttonVisulizarCorrecao" icon="@Embed(source='../../image/relatorio.png')" label="   Visualizar Correção" click="visualizarCorrecao()"/>
		<mx:LinkButton x="636.8" y="551" id="buttonVisualizarNotas" icon="@Embed(source='../../image/relatorio.png')" label="   Visualizar Planilha de Notas" click="visualizarNotas()"/>
		<mx:LinkButton x="626" y="10" visible="false" icon="@Embed(source='../../image/help2.png')" label="  Instruções para Avaliação dos Projetos" id="linkInstrucao"/>
		<mx:Button x="546.05" y="565" visible="false" label="   Atualizar Projeto" width="183.9" height="28" icon="@Embed(source='../../image/lapis.png')" id="botaoAtualizaOrientador"/>
		<mx:Button x="546.05" y="565" visible="false" label="   Avaliar" width="183.9" height="28" icon="@Embed(source='../../image/lapis.png')" id="botaoAvaliacao"/>
		<mx:List x="10" y="70" visible="false" fontSize="12" width="315" height="95" cornerRadius="20" alpha="0.5" id="projetoAvaliacaoList"/>
		<mx:List x="10" y="404" visible="false" fontSize="12" width="315" height="137" cornerRadius="20" alpha="0.5" id="projetoList"/>
		<mx:List x="10" y="202" visible="false" fontSize="12" width="315" height="155" cornerRadius="20" alpha="0.5" id="projetoCotaList"/>
		<mx:Label x="331" y="96" text="Descrição:" id="labelDescRoteiro"/>
		<mx:Label x="333" y="70" text="Título:" id="labelDescRoteiro0"/>
		<mx:Label x="745" y="38" text="Nota do Corretor:"/>
		<mx:Label y="10" text="Nota Automática:" x="748"/>
		<mx:Label x="588" y="423" text="Data de Liberação:"/>
		<mx:Label x="588" y="450" text="Data de Entrega:"/>
		<mx:Label x="588" y="478" text="Data Final para Discussão:"/>
		<mx:Label x="331" y="422" text="Número máximo de envios:"/>
		<mx:Label x="331" y="450" text="Máximo de Integrantes por Equipe:"/>
		<mx:Label x="331" y="478" text="Penalidade por dia de atraso:"/>
		<mx:Label x="10" y="46" text="Projetos para Avaliação:" fontStyle="normal" fontWeight="bold" fontSize="14" id="projetoAvaliacaoLabel" visible="false"/>
		<mx:Label x="10" y="378" text="Meus Projetos:" fontStyle="normal" fontWeight="bold" fontSize="14" id="meusProjetosLabel" visible="false"/>
		<mx:Label x="10" y="176" text="Projetos da Cota Atual:" fontStyle="normal" fontWeight="bold" fontSize="14" id="projetosCotaLabel" visible="false"/>
		<mx:VRule x="302" y="13" height="577"  width="1"/>
		<mx:Label x="557" y="478" width="16" id="inputPenalidades" color="#1B7A0F" text="0" textAlign="right"/>
		<mx:Label x="557" y="450" width="16" id="inputIntegrantesPorEquipe" color="#1B7A0F" text="0" textAlign="right"/>
		<mx:Label x="557" y="422" width="16" id="inputNumeroMaximoEnvios" color="#1B7A0F" text="0" textAlign="right"/>
		<mx:Label x="769" y="422" width="93" id="inputDataLiberacao" color="#1B7A0F"/>
		<mx:Label x="769" y="450" width="93" id="inputDataEntrega" color="#1B7A0F"/>
		<mx:Label x="769" y="478" width="93" id="inputDataFinal" color="#1B7A0F"/>
		<mx:Label x="864" y="422" width="54" id="inputHoraLiberacao" color="#1B7A0F"/>
		<mx:Label x="864" y="450" width="54" id="inputHoraEntrega" color="#1B7A0F"/>
		<mx:Label x="864" y="478" width="54" id="inputHoraDiscussao" color="#1B7A0F"/>
		<mx:TextArea x="331" y="124" width="587" height="279" backgroundAlpha="0.0" id="resumoText" editable="false" alpha="0.5" cornerRadius="10"/>
		<mx:Label x="10" y="14" text="Roteiros:" height="22"/>
		<mx:Label x="10" y="14" text="Roteiros:" height="22"/>
		<mx:List x="10" y="44" scroll="true" width="264" height="399" id="listaRoteiros" labelField="nome" itemClick="atualizaDadosRoteiro()" fontSize="14"/>
		<mx:List x="10" y="489" width="267" height="85" labelFunction="labelIntegrantesEquipeRoteiro" id="integrantesEquipeRoteiro"></mx:List>
		<mx:Label x="386" y="70" width="532" id="inputTituloRoteiro" color="#1B7A0F" text="..."/>
		<mx:Label x="870" y="38" width="48" id="inputNotaCorretor" color="#1B7A0F" text="0,0"/>
		<mx:Label x="870" y="10" width="48" id="inputNotaAutomatica" color="#1B7A0F" text="0,0"/>
	</mx:Canvas>
</mx:TabNavigator>