<?xml version="1.0" encoding="utf-8"?>
<les:ModuleTitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:les="modulos.sistema.*"
	width="452" height="194" title="Reenvio de Senha" layout="absolute" showCloseButton="true"
	close="fechaJanela()" initialize="init()">
	
	<mx:Script>
		<![CDATA[
			import bean.Utilitarios.Util;
			import bean.Utilitarios.CastDeEntidades;
			import bean.acesso.Usuario;
			import Scripts.ControladorDeModulos;
			import mx.utils.StringUtil;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			import eventos.FechaPopupEvent;
			
			[Bindable]
			private var contato: String = "";
			
			[Bindable]
			private var assunto: String = "[e-pic] Reenvio de Senha";
			
			[Bindable]
			private var mensagemEmail: String;
			
			
			private function init():void {
				input_Matricula.setFocus();
				facade.channelSet = ControladorDeModulos.criaCanal();
				systemManager.addEventListener(FechaPopupEvent.FechaPopup_Event, fechaJanelaMensagemAtual);
			}
			
			private function fechaJanelaMensagemAtual(event:FechaPopupEvent):void {
				ControladorDeModulos.descarregaModulo(event.popUp);
				fechaJanela();
			}
			
			private function fechaJanela():void {
				dispatchEvent(new FechaPopupEvent(this));
			}
			
			private function validarCampos():void {
				if(StringUtil.trim(input_Matricula.text) != ""){
					//alterarSenha();
				}else{
					var params:Array = new Array(true, "Matricula inexistente!");
					ControladorDeModulos.criaModulo("modulos/sistema/MensagemStatus.swf", this,params);
				}
			}
			
			private function recuperarSenha():void{
				
			}
			
			private function reenvioSenha_result(event:ResultEvent):void{
				mensagemEmail = "Bem vindo, professor(a) , ao sistema e-pic." +
					"<p>Você poderá acessar o e-pic com:</p>" +
					"Login:<BR> </BR>" + 
					"<BR>Senha:</BR><BR>" + String(event.result) +"</br><p>Obs.:\nLembre-se! Sua senha é pessoal e intransferível. Sendo assim, você é o único responsável " + 
					"por alterações inesperadas no seu projeto.</p>Boa Sorte!";
				mensagemEmail = Util.geraCodigosHTML(mensagemEmail);
				
				//Aqui deverá ser colocado o contato.
				servicoEnviarEmail.send();
			}
			
			private function lancaEvento(event:FaultEvent):void {
				var e:FaultEvent = new FaultEvent(FaultEvent.FAULT, true, true,
					event.fault, event.token, event.message);
				dispatchEvent(e);
			}
			
			private function handleEmail(event:ResultEvent):void {
				ControladorDeModulos.criaModulo("modulos/sistema/MensagemStatus.swf", this,
					[false, "Uma nova senha foi enviada para seu e-mail!"]);
			}
			
			private function falha(event:FaultEvent):void {
				botaoReenviar.enabled = false;
				emailProfessor.text = "";
			}
				
		]]>
	</mx:Script>
	
	<mx:RemoteObject id="facade" destination="easyCorrection" showBusyCursor="true">
		<mx:method name="alterarSenhaAutomatico" result="reenvioSenha_result(event)" fault="falha(event)"/>
	</mx:RemoteObject>
	
	<mx:HTTPService id="servicoEnviarEmail" method="POST" 
    	url="{ExternalInterface.call('getUrlSendMail')}"
    	useProxy="false"
    	resultFormat="text"
    	result="handleEmail(event)"
    	fault="lancaEvento(event)"
    	showBusyCursor="true">
	    <mx:request>
	        <assunto>{assunto}</assunto>
	        <contato>{contato}</contato>
	        <mensagem>{mensagemEmail}</mensagem>
	    </mx:request>
	</mx:HTTPService>
	
	<mx:Form width="414" y="10" x="10" height="90">
		<mx:FormItem label="Matricula:" width="100%" required="true">
			<mx:TextInput id="input_Matricula" maxChars="20" width="100%"/>
		</mx:FormItem>
		<mx:FormItem label="E-mail:" width="100%" height="24">
			<mx:Label id="emailProfessor" width="100%" height="24"/>
		</mx:FormItem>
	</mx:Form>
	<mx:Button x="144.4" y="108" label="Reenviar senha" icon="@Embed(source='../../image/lapis.png')" enabled="false" id="botaoReenviar"/>
	
</les:ModuleTitleWindow>
